name: Analyze, Build and Deploy

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
  push:
    branches:
        - main
  workflow_dispatch:

env:
  JDK_VERSION: 17

jobs:
  safety-check:
    name: Check for modified Gradle
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate Gradle artifacts
      uses: gradle/actions/wrapper-validation@v4

  compile:
    name: Compile Kotlin code
    needs: safety-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for version number generation

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JDK_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Compile Kotlin
        run: ./gradlew assemble

  discover-projects:
    runs-on: ubuntu-latest
    needs: compile
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JDK_VERSION }}

      - name: Discover Projects
        run: |
          ./gradlew projects --quiet | grep -E 'Project :(.+)' | awk '{print $2}' | tr -d ':' > projects.txt
          projects=$(cat projects.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=${projects}" >> $GITHUB_OUTPUT
        id: set-matrix

  detekt:
    name: Generate Detekt report
    needs: discover-projects
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(needs.discover-projects.outputs.matrix) }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required for version number generation

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ env.JDK_VERSION }}

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Run Detekt
      run: ./gradlew :${{ matrix.project }}:detekt
      
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ./sarif/${{ matrix.project }}-build-reports-detekt-detekt.sarif
        category: ${{ matrix.project }}

  unit-test:
    name: Run unit tests
    needs: compile
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required for version number generation

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ env.JDK_VERSION }}

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Run tests
      run: ./gradlew test

    - name: Upload test results
      uses: mikepenz/action-junit-report@v4
      if: always() # Must execute after failed tests
      with:
        report_paths: '**/build/test-results/test/TEST-*.xml'

  platform-test:
    name: Run JUnit tests on ${{ matrix.os }}
    needs: unit-test
    strategy:
      matrix:
        os: [ macos-latest, windows-latest ] # Ubuntu is tested in "test" job
      fail-fast: false # Ensure we get all failures on other platforms
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required for version number generation

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ env.JDK_VERSION }}

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Run tests
      run: ./gradlew test

  spotless:
    name: Run Spotless
    needs: compile
    runs-on: ubuntu-latest
    steps:
      - name: Initial Setup
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for version number generation & diff generation

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JDK_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run Spotless checks
        id: spotlessCheck
        run: ./gradlew spotlessCheck

      - name: Apply Spotless fixes
        if: failure()
        run: ./gradlew spotlessApply

      - name: Generate diff
        if: failure()
        shell: sh
        run: |
          echo "# Spotless violations" >> $GITHUB_STEP_SUMMARY
          echo "```diff" >> $GITHUB_STEP_SUMMARY
          git diff >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
